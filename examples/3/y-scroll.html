<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>横轴视差滚动</title>
        <style>
            body {
                margin: 0;
                padding: 0;
                background: #ddd;
            }

            .container {
                position: relative;
                width: 600px;
                height: 300px;
                margin: 10px auto;
                background: #fff;
                border: thin inset rgba(100,150,230,0.5);
            }

            #readout {
                margin-top: 10px;
                margin-left: 15px;
                color: blue;
                position: absolute;
            }
        </style>
        <script type="text/javascript" src="../../build/source/ig-all.js"></script>
    </head>
    <body>
        <div class="show-frame">帧数：123</div>
        <div class="container">
            <canvas id='canvas' width='600' height='300'></canvas>
        </div>
        <script>
            // image, x, y, zIndex, repeat
            function Background(opts) {
                ig.DisplayObject.apply(this, arguments);
                this.image = opts.image;
                this.repeat = (opts.repeat == 1) ? true : false;
            }
            Background.prototype = {
                constructor: Background,

                render: function (ctx) {
                    if (this.repeat) {
                        ctx.save();
                        var pattern = ctx.createPattern(this.image, 'repeat');
                        ctx.fillStyle= pattern;
                        ctx.fillRect(this.x, this.y, ctx.canvas.width, ctx.canvas.height);
                    }
                    else {
                        ctx.drawImage(this.image, this.x, this.y);
                    }
                }
            }
            ig.util.inherits(Background, ig.DisplayObject);

            // image, speed, x, y, zIndex
            function YScrollBackground(opts) {
                Background.apply(this, arguments);
                this.speed = opts.speed;
                this.sx = 0;
                this.sy = 0;
            }
            YScrollBackground.prototype = {
                update: function () {
                    this.sy = (this.sy + this.speed) % this.image.height;
                },

                render: function (ctx) {
                    if (this.sy + ctx.canvas.height > this.image.height) {
                        var d0 = this.image.height - this.sy;
                        var d1 = ctx.canvas.height - d0;
                        ctx.drawImage(this.image, this.sx, this.sy, this.image.width, d0, this.x, this.y, this.image.width, d0);
                        ctx.drawImage(this.image, this.sx, 0, this.image.width, d1, this.x, this.y + d0, this.image.width, d1);
                    }
                    else {
                        ctx.drawImage(this.image, this.sx, this.sy, ctx.canvas.width, this.image.height, this.x, this.y, ctx.canvas.width, this.image.height);
                    }
                }
            }
            ig.util.inherits(YScrollBackground, Background);

            var canvas = document.querySelector('#canvas');
            var ctx = canvas.getContext('2d');
            var showFrameNode = document.querySelector('.show-frame');

            var imgs = [
                './img/bg1.png',
                './img/bg2.png',
                './img/bg3.png',
            ];

            var il = new ig.ImageLoader();

            for (var i = 0, len = imgs.length; i < len; i++) {
                il.addImage(imgs[i]);
            }

            var imgLoadInterval = setInterval(function (e) {
                var percent = il.loadImages();
                console.log('图片加载进度：' + percent.toFixed() + '%');
                if (percent >= 100) {
                    clearInterval(imgLoadInterval);
                    loadComplate();
                }
            }, 16);

            function loadComplate() {
                var g = new ig.Game();
                g.on('Game:afterRender', function (data) {
                    showFrameNode.innerHTML = ''
                        + '当前帧数：' + data.data.curFrame
                });

                var stage = g.createStage({
                    width: 600,
                    height: 300,
                    containerBgColor: 'rgba(255, 255, 255, 0)',
                    // containerBgColor: '#fff',
                    // containerBgColor: 'white',
                    canvas: canvas
                });

                // var bg1 = new Image();
                // bg1.src = './img/bg1.png';
                // var speed1 = 2;
                // var obj1 = new YScrollBackground({
                //     image: bg1,  // 图像
                //     speed: speed1 * 0.5, // 滚动速度
                //     x: 0, // 图像在画布中的左上角的横轴坐标
                //     y: 0, // 图像在画布中的左上角的纵轴坐标
                //     zIndex: 1
                // });
                // stage.addDisplayObject(obj1);

                var bg2 = new Image();
                bg2.src = './img/bg2.png';
                var speed2 = 4;
                var obj2 = new YScrollBackground({
                    image: bg2,  // 图像
                    speed: speed2 * 0.5, // 滚动速度
                    x: 0, // 图像在画布中的左上角的横轴坐标
                    y: 0, // 图像在画布中的左上角的纵轴坐标
                    zIndex: 2
                });
                stage.addDisplayObject(obj2);

                var bg3 = new Image();
                bg3.src = './img/bg3.png';
                var speed3 = 1;
                var obj3 = new YScrollBackground({
                    image: bg3,  // 图像
                    speed: speed3 * 0.5, // 滚动速度
                    x: 0, // 图像在画布中的左上角的横轴坐标
                    y: 0, // 图像在画布中的左上角的纵轴坐标
                    zIndex: 3
                });
                stage.addDisplayObject(obj3);

                var ballCount = 2;
                for (var i = 0; i < ballCount; i++) {
                    var obj = new ig.Shape.Ball({
                        name: i,
                        r: 10,
                        zIndex: (i % 3) + 1
                    });

                    obj.move(ig.util.randomInt(20, 400), ig.util.randomInt(20, 280));
                    obj.vX = ig.util.randomInt(5, 10);
                    obj.vY = ig.util.randomInt(5, 10);
                    // obj.color = 'red';
                    obj.color = ''
                        + 'rgba('
                        + ig.util.randomInt(0, 255)
                        + ','
                        + ig.util.randomInt(0, 255)
                        + ','
                        + ig.util.randomInt(0, 255)
                        + ', '
                        + ig.util.randomFloat(1, 1)
                        + ')';
                    stage.addDisplayObject(obj);
                }

                g.start();
            }

            setTimeout(function () {
                // g.stop();
            }, 2000);

        </script>
    </body>
</html>
