<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>time-based1</title>
        <style>
            body {
                margin: 0;
                padding: 0;
            }
            canvas {
                /*margin: 100px;*/
                border: 1px solid #ddd;
            }
            div {
                margin: 10px;
            }
        </style>
    </head>
    <body>
        <div>
            <span>60fps:</span>
            <canvas id="canvas60" width="600" height="100"></canvas>
        </div>
        <div>
            <span>30fps:</span>
            <canvas id="canvas30" width="600" height="100"></canvas>
        </div>
        <div>
            <span>10fps:</span>
            <canvas id="canvas10" width="600" height="100"></canvas>
        </div>
        <div>
            <button>开始</button>
        </div>
        <script>
            /**
             * requestAnimationFrame polyfill
             */
            window.requestAnimationFrame = (function () {
                return window.requestAnimationFrame
                    || window.webkitRequestAnimationFrame
                    || window.mozRequestAnimationFrame
                    || window.msRequestAnimationFrame
                    || window.oRequestAnimationFrame
                    || function (callback, elem) {
                            var me = this;
                            var start;
                            var finish;
                            setTimeout(function () {
                                start = +new Date();
                                callback(start);
                                finish = +new Date();
                                me.timeout = 1000 / 60 - (finish - start);
                            }, me.timeout);
                        };
            })();

            /**
             * cancelAnimationFrame polyfill
             */
            window.cancelAnimationFrame = (function () {
                return window.cancelAnimationFrame
                        || window.webkitCancelAnimationFrame
                        || window.webkitCancelRequestAnimationFrame
                        || window.mozCancelAnimationFrame
                        || window.mozCancelRequestAnimationFrame
                        || window.msCancelAnimationFrame
                        || window.msCancelRequestAnimationFrame
                        || window.oCancelAnimationFrame
                        || window.oCancelRequestAnimationFrame
                        || window.clearTimeout;
            })();

            function Circle(opts) {
                this.x = opts.x;
                this.y = opts.y;
                this.vx = opts.vx;
                this.vy = opts.vy;
                this.radius = opts.radius;
                this.ctx = opts.ctx;
                this.fps = opts.fps;
            }

            Circle.prototype.update = function (dt) {
                this.x += this.vx * dt * this.fps / 1000;
                this.y += this.vy * dt * this.fps / 1000;

                // this.x += this.vx * dt * STANDARD_FPS / 1000;
                // this.y += this.vy * dt * STANDARD_FPS / 1000;

                if (this.x - this.radius <= 0 || this.x + this.radius >= this.ctx.canvas.width) {
                    this.vx = -this.vx;
                }
                if (this.y - this.radius <= 0 || this.y + this.radius >= this.ctx.canvas.height) {
                    this.vy = -this.vy;
                }
            }

            Circle.prototype.draw = function () {
                this.ctx.clearRect(0, 0, this.ctx.canvas.width, this.ctx.canvas.height);
                this.ctx.beginPath();
                this.ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, true);
                this.ctx.fill();
            };


            var allTicksPerFrame = 0;
            var STANDARD_FPS = 60;
            var interval = 1 / STANDARD_FPS;

            // function fps60Start() {
            //     var fps = 60;
            //     var circle60 = new Circle({
            //         x: 15,
            //         y: 30,
            //         vx: 5,
            //         vy: 0,
            //         radius: 15,
            //         ctx: document.querySelector('#canvas60').getContext('2d'),
            //         fps: fps
            //     });

            //     var requestId;
            //     var now;
            //     var passed;
            //     var then = Date.now();
            //     var tickUpdateCount = 0;
            //     var ticksPerFrame = 20;

            //     var accumulator = 0;

            //     // var counter = 0;

            //     (function tick() {
            //         requestId = window.requestAnimationFrame(tick);

            //         tickUpdateCount++;
            //         if (tickUpdateCount > ticksPerFrame) {
            //             tickUpdateCount = 0;

            //             // counter = ++counter % STANDARD_FPS;
            //             // if (counter % (STANDARD_FPS / fps) === 0) {
            //                 now = Date.now();
            //                 passed = now - then;
            //                 then = now;

            //                 accumulator += passed; // 累积过去的时间
            //                 while (accumulator >= interval) { // 当时间大于我们的固定的时间片的时候可以进行更新
            //                     circle60.update(interval);  // 分片更新时间
            //                     accumulator -= interval;
            //                 }

            //                 circle60.draw();

            //             // }
            //         }

            //     })();
            // }

            // fps60Start();

            // function fps30Start() {
            //     var fps = 30;
            //     var circle30 = new Circle({
            //         x: 15,
            //         y: 30,
            //         vx: 5,
            //         vy: 0,
            //         radius: 15,
            //         ctx: document.querySelector('#canvas30').getContext('2d'),
            //         fps: fps
            //     });

            //     var requestId;
            //     var now;
            //     var passed;
            //     var then = Date.now();
            //     var tickUpdateCount = 0;
            //     var ticksPerFrame = allTicksPerFrame;

            //     var accumulator = 0;

            //     var counter = 0;

            //     (function tick() {
            //         requestId = window.requestAnimationFrame(tick);

            //         tickUpdateCount++;
            //         if (tickUpdateCount > ticksPerFrame) {
            //             tickUpdateCount = 0;

            //             // counter = ++counter % STANDARD_FPS;
            //             // if (counter % (STANDARD_FPS / fps) === 0) {
            //                 now = Date.now();
            //                 passed = now - then;
            //                 then = now;

            //                 accumulator += passed;
            //                 while (accumulator >= interval) {
            //                     circle30.update(interval);
            //                     accumulator -= interval;
            //                 }

            //                 circle30.draw();

            //             // }
            //         }

            //     })();
            // }

            // fps30Start();

            function fps10Start() {
                var fps = 60;
                var circle10 = new Circle({
                    x: 15,
                    y: 30,
                    vx: 5,
                    vy: 0,
                    radius: 15,
                    ctx: document.querySelector('#canvas10').getContext('2d'),
                    fps: fps
                });

                var requestId;
                var now;
                var passed;
                var then = Date.now();
                var tickUpdateCount = 0;
                var ticksPerFrame = allTicksPerFrame;

                var accumulator = 0;

                (function tick() {
                    requestId = window.requestAnimationFrame(tick);

                    tickUpdateCount++;
                    if (tickUpdateCount > ticksPerFrame) {
                        tickUpdateCount = 0;

                        // counter = ++counter % STANDARD_FPS;
                        // if (counter % (STANDARD_FPS / fps) === 0) {
                            now = Date.now();
                            passed = now - then;
                            then = now;

                            accumulator += passed;
                            while (accumulator >= interval) {
                                circle10.update(interval);
                                accumulator -= interval;
                            }

                            circle10.draw();

                        // }
                    }

                })();
            }


            document.querySelector('button').onclick = function () {
                fps10Start();
            }
        </script>
    </body>
</html>
