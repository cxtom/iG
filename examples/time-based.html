<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Time-based-test1</title>
        <style>
            body {
                margin: 0;
                padding: 0;
            }
            canvas {
                /*margin: 100px;*/
                border: 1px solid #ddd;
            }
            div {
                margin: 10px;
            }
        </style>
    </head>
    <body>
        <div>
            <span>frame-based:</span>
            <canvas id="frame-based-canvas" width="600" height="100"></canvas>
            <button id="frame-based-start">开始</button>
        </div>
        <div>
            <span>timed-based:</span>
            <canvas id="time-based-canvas" width="600" height="100"></canvas>
            <button id="time-based-start">开始</button>
        </div>
        <script>
            /**
             * requestAnimationFrame polyfill
             */
            window.requestAnimationFrame = (function () {
                return window.requestAnimationFrame
                    || window.webkitRequestAnimationFrame
                    || window.mozRequestAnimationFrame
                    || window.msRequestAnimationFrame
                    || window.oRequestAnimationFrame
                    || function (callback, elem) {
                            var me = this;
                            var start;
                            var finish;
                            setTimeout(function () {
                                start = +new Date();
                                callback(start);
                                finish = +new Date();
                                me.timeout = 1000 / 60 - (finish - start);
                            }, me.timeout);
                        };
            })();

            /**
             * cancelAnimationFrame polyfill
             */
            window.cancelAnimationFrame = (function () {
                return window.cancelAnimationFrame
                        || window.webkitCancelAnimationFrame
                        || window.webkitCancelRequestAnimationFrame
                        || window.mozCancelAnimationFrame
                        || window.mozCancelRequestAnimationFrame
                        || window.msCancelAnimationFrame
                        || window.msCancelRequestAnimationFrame
                        || window.oCancelAnimationFrame
                        || window.oCancelRequestAnimationFrame
                        || window.clearTimeout;
            })();

            function Circle(opts) {
                this.x = opts.x;
                this.y = opts.y;
                this.vx = opts.vx;
                this.vy = opts.vy;
                this.radius = opts.radius;
                this.ctx = opts.ctx;
                this.fps = opts.fps;
            }

            Circle.prototype.update = function (dt) {
                this.x += this.vx * dt * this.fps / 1000;
                this.y += this.vy * dt * this.fps / 1000;

                if (this.x - this.radius <= 0 || this.x + this.radius >= this.ctx.canvas.width) {
                    this.vx = -this.vx;
                }
                if (this.y - this.radius <= 0 || this.y + this.radius >= this.ctx.canvas.height) {
                    this.vy = -this.vy;
                }
            }

            Circle.prototype.draw = function () {
                this.ctx.clearRect(0, 0, this.ctx.canvas.width, this.ctx.canvas.height);
                this.ctx.beginPath();
                this.ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, true);
                this.ctx.fill();
            };

            var allTicksPerFrame = 10;

            function frameBasedStart() {
                var STANDARD_FPS = 60;
                var interval = 1 / STANDARD_FPS;
                var fps = 60;
                var circle = new Circle({
                    x: 15,
                    y: 30,
                    vx: 5,
                    vy: 0,
                    radius: 15,
                    ctx: document.querySelector('#frame-based-canvas').getContext('2d'),
                    fps: fps
                });

                circle.update = function () {
                    this.x += this.vx;
                    this.y += this.vy;

                    if (this.x - this.radius <= 0 || this.x + this.radius >= this.ctx.canvas.width) {
                        this.vx = -this.vx;
                    }
                    if (this.y - this.radius <= 0 || this.y + this.radius >= this.ctx.canvas.height) {
                        this.vy = -this.vy;
                    }
                };

                var requestId;
                var now;
                var passed;
                var then = Date.now();
                var tickUpdateCount = 0;
                var ticksPerFrame = allTicksPerFrame;

                var accumulator = 0;

                (function tick() {
                    requestId = window.requestAnimationFrame(tick);

                    tickUpdateCount++;
                    if (tickUpdateCount > ticksPerFrame) {
                        tickUpdateCount = 0;
                        now = Date.now();
                        passed = now - then;
                        then = now;

                        circle.update();
                        circle.draw();
                    }
                })();
            }

            function timeBasedStart() {
                var STANDARD_FPS = 60;
                var interval = 1 / STANDARD_FPS;
                var fps = 60;
                var circle = new Circle({
                    x: 15,
                    y: 30,
                    vx: 5,
                    vy: 0,
                    radius: 15,
                    ctx: document.querySelector('#time-based-canvas').getContext('2d'),
                    fps: fps
                });

                var requestId;
                var now;
                var passed;
                var then = Date.now();
                var tickUpdateCount = 0;
                var ticksPerFrame = allTicksPerFrame;

                var accumulator = 0;

                (function tick() {
                    requestId = window.requestAnimationFrame(tick);

                    tickUpdateCount++;
                    if (tickUpdateCount > ticksPerFrame) {
                        tickUpdateCount = 0;
                        now = Date.now();
                        passed = now - then;
                        then = now;

                        accumulator += passed;
                        while (accumulator >= interval) {
                            circle.update(interval);
                            accumulator -= interval;
                        }

                        circle.draw();
                    }
                })();
            }


            document.querySelector('#frame-based-start').onclick = function () {
                frameBasedStart();
            }

            document.querySelector('#time-based-start').onclick = function () {
                timeBasedStart();
            }
        </script>
    </body>
</html>
